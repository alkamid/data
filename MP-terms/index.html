<html>

    <head>
        
        <meta charset="utf-8">
        
        <script src='d3.min.js'></script>
        <style>input.vertical { -webkit-appearance: slider-vertical; writing-mode: bt-lr; }
        
        #header {
            background-color:black;
            color:white;
            text-align:center;
            padding:5px;
        }
            
        #controls {
            float:left;
            padding-top:90px;
        }
            
        #histogram {
            float:left;
            padding-left:70px;
            padding-top:30px;
        }
            
        </style>
    </head>

    <body>
    
        <div id="header">
            <h1>Sejm VII kadencji</h1>
        </div>
        
        <div id="seats">
            <svg width=1000 height=500></svg>
        </div>
        
        <div id="controls">
            <select id="parties"></select>
            <p id="sliderText">term threshold: 1</p>
            <input type=range min=1 max=7 value=1 class=vertical orient=vertical></input>
       
            <button id='party'>by party</button>
            <button id='term'>by term</button>
            <button id='PO'>PO</button>
        
        </div>
        
        <div id='histogram'>
            <svg width=400 height=220 id='histogram'></svg>
        </div>
        
        
        
        <script>
    
            var svg = d3.select('svg')
            var svgHisto = d3.select('svg#histogram')
            
            function sortPoints(byWhat, a, b){
                if (byWhat == 'terms') {
                
                    byparty = d3.descending(+a['recent-mp'], +b['recent-mp'])
                    if (byparty != 0)
                        return byparty
                    else {
                        if (a.club < b.club)
                            return -1;
                        else if (a.club > b.club)
                            return 1;
                        else {
                            return d3.ascending(a.dob,b.dob)
                        }
                    }
                }
                else {
                    if (a.club < b.club)
                       return -1;
                    if (a.club > b.club)
                       return 1;                
                    return d3.descending(+a['recent-mp'], +b['recent-mp']) || d3.ascending(a.dob,b.dob)                                
                }                          
            }
            
        var rows = 15
        var xSpacing = 25
        var ySpacing = 25
        var scale = 3            
        
        
        //read in the database, sort by number of terms in office, then by parliamentary club (i.e. party)
        d3.csv('data/processed.csv', function(db){
            
            byRecentTerm = d3.nest()
                .key(function(d){
                    return d['recent-mp']
                })
                .key(function(d){
                    return d['club']
                })
                .sortKeys(d3.ascending)
                .entries(db)
            
            
            function getTotalMPs(dataSet){
                return d3.nest()
                    .key(function(d){
                        return d['recent-mp']
                    })
                    .rollup(function(d){
                        return d.length
                    })
                    .sortKeys(d3.ascending)
                    .entries(dataSet)
            }
            
            //total mp numbers for each term value
            mpTotals = getTotalMPs(db)
            var sumMPs = 0
            mpTotals.forEach(function(d){ sumMPs += d.values})
            
            histoScale = d3.scale.linear()
                .domain([0, d3.max(mpTotals).values])
                .range([0, 200])
            
            histoVertScale = d3.scale.linear()
                .domain([0, 15])
                .range([0, 0.15*sumMPs])
            
            var linesArr = []
            for (var i = 1; i<Math.floor(d3.max(mpTotals).values/(0.05*sumMPs)); i++) {
                linesArr.push(i*5)
            }
            
            
            histVertLines = svgHisto.selectAll('line')
                .data(linesArr, lineVal)
                .enter()
                .append('line')
                .attr('y1', function(d){
                    return 200-histoVertScale(d)
                })
                .attr('y2', function(d){
                    return 200-histoVertScale(d)
                })
                .attr('x1', 0)
                .attr('x2', 400)
                .style('stroke', 'black')
                .style('opacity', 0.6)
                .attr('stroke-dasharray', (5,5))
            
                 
            histogramGroup = svgHisto.selectAll('#histoGroup')
                .data(byRecentTerm)
                .enter()
                .append('g')
                .attr('id', 'histoGroup')
                .attr('transform', function(d, i){
                    return 'translate (' + (30+i*50) + ', 200)'
                })
                
            
            
            function changeHisto() {
                var val = selectedItem.property('value')
                newdb = db.filter(function(d){
                            return d['club'] == val
                        })
                newData = d3.nest()
                    .key(function(d){
                        return d['recent-mp']
                    })
                    .key(function(d){
                        return d['club']
                    })
                    .sortKeys(d3.ascending)
                    .entries(newdb)
                
                updateHist(newData, newdb)
            }
            
            function updateHist(newDataSet, newdb) {
                
                var ytrac = [0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                
                histogramGroup.selectAll('rect')
                    .remove()
                
                histogramGroup.data(newDataSet)
                
                
                mpTotals = getTotalMPs(newdb)
               
                var sumMPs = 0
                mpTotals.forEach(function(d){ sumMPs += d.values})

                
                var linesArr = []
                    for (var i = 1; i<Math.floor(d3.max(mpTotals).values/(0.05*sumMPs)); i++) {
                        linesArr.push(i*5)
                    }

                
                histoScale = d3.scale.linear()
                    .domain([0, d3.max(mpTotals).values])
                    .range([0, 200])

                histoVertScale = d3.scale.linear()
                    .domain([0, linesArr[linesArr.length-1]])
                    .range([0, linesArr[linesArr.length-1]*sumMPs])
                
                console.log(histoVertScale(20))
                
                
                histogramGroup.selectAll('rect')
                    .data(function(d) { return d.values; })
                    .enter()
                    .append('rect')
                    
                    .attr('width', 30)
                    .attr('fill', function(d){
                        return partyColors(d.key)
                    })
                    .attr('height', 0)
                    .attr('y', 0)
                    .transition()
                    .duration(500)
                    .attr('height', function(d){
                        return histoScale(d.values.length)
                    })
                    .attr('y', function(d,i,j){
                        ytrac[j] -= histoScale(d.values.length)
                        return ytrac[j]
                    })
                
            
                histVertLines = svgHisto.selectAll('line')
                    .data(linesArr, lineVal)
                    .exit()
                    .remove()
            
                histVertLines = svgHisto.selectAll('line')
                    .data(linesArr, lineVal)
                    .attr('x1', 0)
                    .attr('x2', 400)
                    .style('stroke', 'black')
                    .style('opacity', 0.6)
                    .attr('stroke-dasharray', (5,5))
                    .transition()
                    .duration(500)
                    .attr('y1', function(d){
                        return 200-histoScale(d*0.01*sumMPs)
                    })
                    .attr('y2', function(d){
                        return 200-histoScale(d*0.01*sumMPs)
                    })

                    
            
            }
            
            var ytrac = [0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            
            histogramGroup.selectAll('rect')
                .data(function(d) { return d.values; })
                .enter()
                .append('rect')
                .attr('height', function(d){
                    return histoScale(d.values.length)
                })
                .attr('y', function(d,i,j){
                    ytrac[j] -= histoScale(d.values.length)
                    return ytrac[j]
                })
                .attr('width', 30)
                .attr('fill', function(d){
                    return partyColors(d.key)
                })

            
            
            
            //add labels over the histogram
            svgHisto.selectAll('#histoGroup')
                .data(mpTotals)
                .append('text')
                .text(function(d){
                    return ''+d.values
                })
                .attr('y', function(d, i){
                    return ytrac[i] - 10
                })
            
            //add x axis ticks
            svgHisto.selectAll('#histoGroup')
                .data(mpTotals)
                .append('text')
                .text(function(d,i){
                    return ''+(i+1)
                })
                .attr('y', 20)
                .attr('x', 10)
            
            svgHisto.append('text')
                .text('terms: ')
                .attr('x', -30)
                .attr('y', 220)
             
            
            function name(d){
                return d.name
            }
            
            function lineVal(d){
                return d
            }
           
           db.sort(function(a,b){
               return sortPoints('party', a, b)
           })
           
           db = db.filter(function(d){
                return d.expired == 'None'
           })
           
            svg.selectAll('rect')
                .data(db, name)
                .enter()
                .append('rect')
                .attr('id', 'mp_dots')
                .attr('x', function(d,i){
                    return (50+(Math.floor(i/rows))*xSpacing)
                })
                .attr('y', function(d,i){
                    return (50+(i%rows)*ySpacing)
                })
                .attr('width', function(d){
                    return scale*d['recent-mp']
                })
                .attr('height', function(d){
                    return scale*d['recent-mp']
                })
                .attr('fill', function(d){
                    return partyColors(d.club)
                })
                .on('mouseover', function(d){
                    svg.append('text')
                        .attr('id', 'tooltip')
                        .attr('font-family', 'Fira Sans')
                        .text(d.name)
                        .attr('x', 200)
                        .attr('y', 450)
                    
                    svg.select('g#termBarGroup').selectAll('rect')
                        .data(d['history-mp'].split(':'))
                        .style('fill-opacity', function(d){
                            if (d == 1)
                                return 1.0
                            else
                                return 0.3
                        })
                })
                .on('mouseout', function(){
                    svg.selectAll('#tooltip')
                        .remove()
                    
                    svg.select('g#termBarGroup').selectAll('rect')
                        .style('fill-opacity', 0.3)
                })
            
            
            termIndicator = svg.append('g')
                .attr('id', 'termBarGroup')
                .attr('transform', 'translate(400, 440)')
            
            
            var termDuration = [1.5,4,4,4,2,4,4]
            
            termIndicator.selectAll('rect')
                .data(termDuration)
                .enter()
                .append('rect')
                .attr('id', function(d,i){
                    return 'termBar_' + (i+1)
                })
                .attr('x', function(d,i){
                    return d3.sum(termDuration.slice(0, i))*15+i*3
                })
                .attr('width', function(d){
                    return d*15
                })
                .attr('height', 20)
                .style('fill-opacity', 0.3)

            
            termIndicator.selectAll('text')
                .data(termDuration)
                .enter()
                .append('text')
                .attr('y', 40)
                .text(function(d,i) { 
                    return '\'' + ('00' + Math.ceil(91+d3.sum(termDuration.slice(0, i)))%100).substr(-2) })
                .attr('x', function(d,i){
                    return d3.sum(termDuration.slice(0, i))*15+i*3-10
                })
            
            
            //console.log(test)
            
            d3.select('body').select('.vertical')
                .on('change', function(d) {
                    var val = this.value
                    svg.selectAll('rect#mp_dots')
                        .attr('fill-opacity', function(d){
                            if (d['recent-mp'] <= val)
                                return 0.4
                            else
                                return 1.0
                        })
                    svgHisto.selectAll('#histoGroup').selectAll('rect')
                        .attr('fill-opacity', function(d, i,j){

                        if (j < val-1)
                            return 0.6
                        else
                            return 1
                        })
                    d3.select('p#sliderText')
                        .text(function(){
                            return 'term threshold: ' + val
                        })
                    
                })
            
            
            d3.select('body').selectAll('button')
                .data(['party', 'terms'])
                .on('click', function(d){
                
                    newd = db.sort(function(a,b){
                        return sortPoints(d, a, b)
                    })

                    svg.selectAll('rect').data(newd, name)
                        .transition()
                        .duration(1000)
                        .attr('x', function(d,i){
                            return (50+(Math.floor(i/rows))*xSpacing)
                        })
                        .attr('y', function(d,i){
                            return (50+(i%rows)*ySpacing)
                        })
                    
                    
                    })

                    
            parties = d3.nest()
                .key(function(d){
                    return d.club
                })
                .entries(db)
            
            d3.select('select#parties').selectAll('option')
                .data(parties)
                .enter()
                .append('option')
                .text(function(d){
                    return d.key
                })
            
            var selectedItem = d3.select('select#parties').on('change', changeHisto)
                
            
            function partyColors(club){
                switch (club) {
                    case 'Klub Parlamentarny Platforma Obywatelska':
                        return 'darkorange';
                    case 'Klub Parlamentarny Prawo i Sprawiedliwość':
                        return 'darkblue';
                    case 'Klub Parlamentarny Polskiego Stronnictwa Ludowego':
                        return '#4daf4a';
                    case 'Klub Poselski Sojusz Lewicy Demokratycznej':
                        return 'red';
                    case 'Klub Parlamentarny Zjednoczona Prawica':
                        return '#377eb8';

                    default:
                        return 'grey';
                }
            }
            
        });
        
        
        
        
        
        
        
        </script>
    
    
    </body>



</html>
