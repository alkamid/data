<html>

    <head>
        
        <meta charset="utf-8">
        
        <script src='d3.min.js'></script>
        <style>input.vertical { -webkit-appearance: slider-vertical; writing-mode: bt-lr; }
        
        #header {
            background-color:black;
            color:white;
            text-align:center;
            padding:5px;
        }
            
        #controls {
            float:left;
            width: 40%;
            padding-top:90px;
        }
            
        #histogram {
            float:left;
            width: 50%;
            padding-left:70px;
            padding-top:30px;
        }
            
        div#total {
            width: 50%;
        }
            
        #histograms {
            float:left;
        }
            
        body {
            font-family: 'Fira Sans';
            background-color: #fffff9;
        }
            
        button {
            font-family: 'Open Sans', sans-serif;
            font-weight: 400;
            text-transform: uppercase;
            font-size: 14px;
            color: #eee;
            background-color: #333;
            padding: 10 16;
            margin: 6px;
            border: none;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
        }
        
        button: hover {
            background-color: #666;
        }
            
        </style>
    </head>

    <body>
    
        <div id="header">
                <h1>Sejm VII kadencji</h1>
        </div>
        
        <div id="total">
        
            

            <div id="seats">
                <svg width=1000 height=500></svg>
            </div>

            <div>

                <div id="controls">
                    <p id="sliderText">term threshold: 1</p>
                    <input type=range min=1 max=7 value=1 class=vertical orient=vertical></input>

                    <button id='party'>by party</button>
                    <button id='term'>by term</button>

                </div>

                <div id='histogram'>
                    <svg width=400 height=220 id='histogram'></svg>
                </div>

            </div>

            <div id='histograms'>
                <svg width=1000 height=920 id='histograms'></svg>
            </div>
        
        </div>
        
        <script>
    
            var svg = d3.select('svg')
            var svgHisto = d3.select('svg#histogram')
            var svg_histograms = d3.select('svg#histograms')
            
            function sortPoints(byWhat, a, b){
                if (byWhat == 'terms') {
                
                    byparty = d3.descending(+a['recent-mp'], +b['recent-mp'])
                    if (byparty != 0)
                        return byparty
                    else {
                        if (a['party_name'] < b['party_name'])
                            return -1;
                        else if (a['party_name'] > b['party_name'])
                            return 1;
                        else {
                            return d3.ascending(a.dob,b.dob)
                        }
                    }
                }
                else {
                    if (a['party_name'] < b['party_name'])
                       return -1;
                    if (a['party_name'] > b['party_name'])
                       return 1;                
                    return d3.descending(+a['recent-mp'], +b['recent-mp']) || d3.ascending(a.dob,b.dob)                                
                }                          
            }
            
        var rows = 15
        var xSpacing = 25
        var ySpacing = 25
        var scale = 3            
        
        
        //read in the database, sort by number of terms in office, then by parliamentary club (i.e. party)
        d3.csv('data/processed.csv', function(db){
            
            db = db.filter(function(d){
                return d.expired == 'None'
            })
            
            byRecentTerm = d3.nest()
                .key(function(d){
                    return d['recent-mp']
                })
                .key(function(d){
                    return d['party_name']
                })
                .sortKeys(d3.ascending)
                .entries(db)
            
            function name(d){
                return d.name
            }
            
            function lineVal(d){
                return d
            }
            
            function getTotalMPs(dataSet){
                return d3.nest()
                    .key(function(d){
                        return d['recent-mp']
                    })
                    .rollup(function(d){
                        return d.length
                    })
                    .sortKeys(d3.ascending)
                    .entries(dataSet)
            }
            
            function define_vertical_lines(input_data, sumMPs) {
                
                var linesArr = []
                var maxMPs = d3.max(input_data).values
                var maxProportion = maxMPs/sumMPs
                
                if (Math.floor((maxProportion)/0.05) <= 5) {
                    for (var i = 1; i<=Math.floor(maxMPs/(0.05*sumMPs)); i++) {
                        linesArr.push(i*5)
                    }
                }
                else if (Math.floor((maxProportion)/0.10) <= 5) {
                    for (var i = 1; i<=Math.floor(maxMPs/(0.1*sumMPs)); i++) {
                        linesArr.push(i*10)
                    }
                }
                else {
                    for (var i = 1; i<=Math.floor(maxMPs/(0.2*sumMPs)); i++) {
                        linesArr.push(i*20)
                    }
                }
                return linesArr;
                }
             
            
            
            function partyHistogram(newDataSet, newdb, i, main_histogram) {
                
                main_histogram = typeof main_histogram !== 'undefined' ? main_histogram : false;
                
                var yticks_fontsize = 15
                var xticks_fontsize = 10

                
                if (main_histogram == true) {
                    var bar_width = 30;
                    var histogram_height = 200;
                    var bar_separation = 40;
                    var group_xtranslation = 0;
                    var group_ytranslation = 0;
                    var svg = svgHisto;
                }
                else {
                    var bar_width = 17;
                    var histogram_height = 110;
                    var bar_separation = 25;
                    var group_xtranslation = i%3*250;
                    var group_ytranslation = (100+Math.floor(i/3)*280);
                    var svg = svg_histograms;
                }
                
                var ytrac = [0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                
                histogramWhole = svg
                                .append('g')
                                .attr('id', 'party-histo')
                                .attr('transform', function() { return 'translate(' + group_xtranslation + ',' + group_ytranslation + ')' })
                                      

                
                mpTotals = getTotalMPs(newDataSet)
               
                var sumMPs = 0
                mpTotals.forEach(function(d){ sumMPs += d.values})

                
                linesArr = define_vertical_lines(mpTotals, sumMPs)
                
                histoScale = d3.scale.linear()
                    .domain([0, d3.max(mpTotals).values])
                    .range([0, histogram_height])

                histoVertScale = d3.scale.linear()
                    .domain([0, linesArr[linesArr.length-1]])
                    .range([0, linesArr[linesArr.length-1]*sumMPs])
                
            
        
                histVertLines = histogramWhole.selectAll('line')
                    .data(linesArr, lineVal)
                    .enter()
                    .append('line')
                    .attr('x1', 30-0.5*bar_width)
                    .attr('x2', bar_separation*8)
                    .style('stroke', 'black')
                    .style('opacity', 0.2)
                    .attr('stroke-dasharray', 3)
                    .transition()
                    .duration(500)
                    .attr('y1', function(d){
                        return 200-histoScale(d*0.01*sumMPs)
                    })
                    .attr('y2', function(d){
                        return 200-histoScale(d*0.01*sumMPs)
                    })
                    
                
                histogramGroup = histogramWhole.selectAll('#histoGroup')
                .data(newdb)
                .enter()
                .append('g')
                .attr('id', 'histoGroup')
                .attr('transform', function(d){
                    return 'translate (' + (30+(d.key-2)*bar_separation) + ', 200)';
                })                
                                
                histogramGroup.selectAll('rect')
                    .data(function(d) { return d.values; })
                    .enter()
                    .append('rect')
                    
                    .attr('width', bar_width)
                    .attr('fill', function(d){
                        return partyColors(d.key)
                    })
                    .attr('height', 0)
                    .attr('y', 0)
                    .transition()
                    .duration(500)
                    .attr('height', function(d){
                        return histoScale(d.values.length)
                    })
                    .attr('y', function(d,i,j){
                        ytrac[j] -= histoScale(d.values.length)
                        return ytrac[j]
                    })

            //add labels above the bars
            histogramWhole.selectAll('#histoGroup')
                .data(mpTotals)
                .append('text')
                .attr('font-family', 'Fira Sans')
                .attr('font-size', yticks_fontsize)
                .text(function(d){
                    return ''+d.values
                })
                .attr('y', function(d, i){
                    return ytrac[i] - 10
                })
                .attr('x', function(d){
                    return (bar_width/2)-(d.values.toString().length*yticks_fontsize*0.5/2)
                })
            
            
            //add x axis ticks
            histogramWhole.selectAll('#histoGroup')
                .data(mpTotals)
                .append('text')
                .attr('font-family', 'Fira Sans')
                .attr('font-size', xticks_fontsize)
                .text(function(d){
                    return ''+(d.key-1)
                })
                .attr('y', 20)
                .attr('x', (bar_width/2)-(xticks_fontsize*0.5/2)) // this is a crude method to center the text. There must be a better one
            
            console.log(newDataSet)

            if (main_histogram != true) {
            
            var title = newDataSet[0]['party_name']
            histogramWhole.append('text')
                .text(title)
                .attr('font-family', 'Fira Sans')
                .attr('font-size', 15)
                .attr('x', 30)
                .attr('y', 10)        
            
            }
            else {
                histogramWhole.append('text')
                .text('terms: ')
                .attr('x', -30)
                .attr('y', 220)        
            }
            }
            
            // draw the main histogram (with all parties)
            partyHistogram(db, byRecentTerm, 1, true)
            

            
           
           db.sort(function(a,b){
               return sortPoints('party_name', a, b)
           })
           
           
           
            svg.selectAll('rect')
                .data(db, name)
                .enter()
                .append('rect')
                .attr('id', 'mp_dots')
                .attr('x', function(d,i){
                    return (50+(Math.floor(i/rows))*xSpacing)
                })
                .attr('y', function(d,i){
                    return (50+(i%rows)*ySpacing)
                })
                .attr('width', function(d){
                    return scale*d['recent-mp']
                })
                .attr('height', function(d){
                    return scale*d['recent-mp']
                })
                .attr('fill', function(d){
                    return partyColors(d['party_name'])
                })
                .on('mouseover', function(d){
                    svg.append('text')
                        .attr('id', 'tooltip')
                        .attr('font-family', 'Fira Sans')
                        .text(d.name + ' (' + d.party_acronym + ')')
                        .attr('x', 50)
                        .attr('y', 455)
                    
                    svg.select('g#termBarGroup').selectAll('rect')
                        .data(d['history-mp'].split(':'))
                        .style('fill-opacity', function(d){
                            if (d == 1)
                                return 1.0
                            else
                                return 0.3
                        })
                })
                .on('mouseout', function(){
                    svg.selectAll('#tooltip')
                        .remove()
                    
                    svg.select('g#termBarGroup').selectAll('rect')
                        .style('fill-opacity', 0.3)
                })
            
            
            termIndicator = svg.append('g')
                .attr('id', 'termBarGroup')
                .attr('transform', 'translate(400, 440)')
            
            
            var termDuration = [1.5,4,4,4,2,4,4]
            
            termIndicator.selectAll('rect')
                .data(termDuration)
                .enter()
                .append('rect')
                .attr('id', function(d,i){
                    return 'termBar_' + (i+1)
                })
                .attr('x', function(d,i){
                    return d3.sum(termDuration.slice(0, i))*15+i*3
                })
                .attr('width', function(d){
                    return d*15
                })
                .attr('height', 20)
                .style('fill-opacity', 0.3)

            
            termIndicator.selectAll('text')
                .data(termDuration)
                .enter()
                .append('text')
                .attr('y', 40)
                .text(function(d,i) { 
                    return '\'' + ('00' + Math.ceil(91+d3.sum(termDuration.slice(0, i)))%100).substr(-2) })
                .attr('x', function(d,i){
                    return d3.sum(termDuration.slice(0, i))*15+i*3-10
                })
            

            d3.select('body').select('.vertical')
                .on('change', function(d) {
                    var val = this.value
                    svg.selectAll('rect#mp_dots')
                        .attr('fill-opacity', function(d){
                            if (d['recent-mp'] <= val)
                                return 0.4
                            else
                                return 1.0
                        })
                    svgHisto.selectAll('#histoGroup').selectAll('rect')
                        .attr('fill-opacity', function(d, i,j){

                        if (j < val-1)
                            return 0.6
                        else
                            return 1
                        })
                    d3.select('p#sliderText')
                        .text(function(){
                            return 'term threshold: ' + val
                        })
                    
                })
            
            
            d3.select('body').selectAll('button')
                .data(['party', 'terms'])
                .on('click', function(d){
                
                    newd = db.sort(function(a,b){
                        return sortPoints(d, a, b)
                    })

                    svg.selectAll('rect').data(newd, name)
                        .transition()
                        .duration(1000)
                        .attr('x', function(d,i){
                            return (50+(Math.floor(i/rows))*xSpacing)
                        })
                        .attr('y', function(d,i){
                            return (50+(i%rows)*ySpacing)
                        })
                    
                    
                    })

                    
            parties = d3.nest()
                .key(function(d){
                    return d['party_name']
                })
                .entries(db)
            
            
            
            
            parties.forEach(function(d, i){
                newdb = db.filter(function(e){
                            return e['party_name'] == d.key
                        })
                newData = d3.nest()
                    .key(function(e){
                        return e['recent-mp']
                    })
                    .key(function(e){
                        return e['party_name']
                    })
                    .sortKeys(d3.ascending)
                    .entries(newdb)
                

                partyHistogram(newdb, newData, i)
            })
                            
            
            function partyColors(party_name){
                switch (party_name) {
                    case 'Platforma Obywatelska':
                        return 'darkorange';
                    case 'Prawo i Sprawiedliwość':
                        return 'darkblue';
                    case 'Polskie Stronnictwo Ludowe':
                        return '#4daf4a';
                    case 'Sojusz Lewicy Demokratycznej':
                        return 'red';
                    case 'Zjednoczona Prawica':
                        return '#377eb8';
                    case 'Ruch Palikota':
                        return '#FFB964';
                    case 'Biało-Czerwoni':
                        return '#D46A6A';
                    default:
                        return 'grey';
                }
            }
            
        });
        
        
        
        
        
        
        
        </script>
    
    
    </body>



</html>
